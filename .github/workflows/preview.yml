name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    # Only run if Vercel secrets are configured
    # If using Vercel's GitHub integration, this workflow is optional
    if: ${{ secrets.VERCEL_TOKEN != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview-url=$url" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const previewUrl = '${{ steps.deploy.outputs.preview-url }}';
            const deploymentStep = '${{ steps.deploy.outcome }}';
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('Preview deployment')
            );
            
            let commentBody;
            if (deploymentStep === 'success' && previewUrl) {
              commentBody = `## üöÄ Preview Deployment
              
              Your preview is ready! View it at:
              **${previewUrl}**
              
              > This preview will be updated automatically when you push new commits.`;
            } else {
              commentBody = `## ‚ö†Ô∏è Preview Deployment
              
              Preview deployment failed. Please check the workflow logs for details.
              
              To set up Vercel previews:
              1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
              2. Import this repository
              3. Add the following secrets to this repository:
                 - \`VERCEL_TOKEN\` - Get from Vercel ‚Üí Settings ‚Üí Tokens
                 - \`VERCEL_ORG_ID\` - Found in Vercel project settings
                 - \`VERCEL_PROJECT_ID\` - Found in Vercel project settings
              
              Alternatively, you can test locally by running:
              \`\`\`bash
              bun run dev
              \`\`\``;
            }
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
            }

