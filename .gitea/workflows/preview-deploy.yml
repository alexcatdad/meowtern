name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  REGISTRY: git.escu.dev
  IMAGE_NAME: git.escu.dev/${{ gitea.repository }}
  GITEA_API: http://gitea.core.svc.cluster.local:3000
  PR_NUMBER: ${{ gitea.event.pull_request.number }}
  PREVIEW_URL: https://pr-${{ gitea.event.pull_request.number }}.preview.escu.dev

jobs:
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set pending status
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $REGISTRY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"state": "pending", "target_url": "${{ env.PREVIEW_URL }}", "description": "Preview deployment in progress...", "context": "preview"}' \
            "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/statuses/${{ gitea.sha }}"

      - name: Login to Registry
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
          REGISTRY_USER: ${{ vars.REGISTRY_USER }}
        run: |
          printf '%s' "$REGISTRY_TOKEN" | docker login ${{ env.REGISTRY }} -u "$REGISTRY_USER" --password-stdin

      - name: Build and Push
        run: |
          docker build -t "${{ env.IMAGE_NAME }}:pr-${{ env.PR_NUMBER }}" .
          docker push "${{ env.IMAGE_NAME }}:pr-${{ env.PR_NUMBER }}"

      - name: Setup kubectl
        run: |
          curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && mv kubectl /usr/local/bin/

      - name: Configure kubeconfig
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG_CONTENT }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_CONTENT" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy Preview
        run: |
          NAMESPACE="preview-pr-${{ env.PR_NUMBER }}"
          APP_NAME="meowtern"
          IMAGE="${{ env.IMAGE_NAME }}:pr-${{ env.PR_NUMBER }}"
          HOST="pr-${{ env.PR_NUMBER }}.preview.escu.dev"

          # Create namespace
          kubectl create namespace "$NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace "$NAMESPACE" preview.homelab/managed=true preview.homelab/pr-number="${{ env.PR_NUMBER }}" --overwrite

          # Copy TLS secret
          kubectl get secret preview-wildcard-tls-secret -n kube-system -o json | \
            jq --arg ns "$NAMESPACE" '.metadata.namespace = $ns | del(.metadata.resourceVersion, .metadata.uid, .metadata.creationTimestamp)' | \
            kubectl apply -f -

          # Apply manifests
          kubectl apply -f - <<EOF
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${APP_NAME}-pr-${{ env.PR_NUMBER }}
            namespace: ${NAMESPACE}
            labels:
              app: ${APP_NAME}
              preview: "true"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: ${APP_NAME}
            template:
              metadata:
                labels:
                  app: ${APP_NAME}
              spec:
                containers:
                - name: ${APP_NAME}
                  image: ${IMAGE}
                  imagePullPolicy: Always
                  ports:
                  - containerPort: 80
                  resources:
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
                    requests:
                      cpu: "50m"
                      memory: "64Mi"
                nodeSelector:
                  role: homelab-worker
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${APP_NAME}-pr-${{ env.PR_NUMBER }}
            namespace: ${NAMESPACE}
          spec:
            selector:
              app: ${APP_NAME}
            ports:
            - port: 80
              targetPort: 80
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${APP_NAME}-pr-${{ env.PR_NUMBER }}
            namespace: ${NAMESPACE}
          spec:
            tls:
            - hosts:
              - ${HOST}
              secretName: preview-wildcard-tls-secret
            rules:
            - host: ${HOST}
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ${APP_NAME}-pr-${{ env.PR_NUMBER }}
                      port:
                        number: 80
          EOF

          # Wait for deployment
          kubectl rollout status deployment/${APP_NAME}-pr-${{ env.PR_NUMBER }} -n ${NAMESPACE} --timeout=120s

      - name: Set success status
        if: success()
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $REGISTRY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"state": "success", "target_url": "${{ env.PREVIEW_URL }}", "description": "Preview deployed!", "context": "preview"}' \
            "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/statuses/${{ gitea.sha }}"

          # Comment on PR (update existing or create new)
          EXISTING=$(curl -s -H "Authorization: token $REGISTRY_TOKEN" \
            "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/issues/${{ env.PR_NUMBER }}/comments" | \
            jq -r '.[] | select(.body | contains("Preview Deployment")) | .id' | head -1)

          BODY="## Preview Deployment\n\n**URL:** ${{ env.PREVIEW_URL }}\n\n**Commit:** \`${{ gitea.sha }}\`\n\nThis preview will be automatically destroyed when the PR is closed."

          if [ -n "$EXISTING" ]; then
            curl -s -X PATCH -H "Authorization: token $REGISTRY_TOKEN" -H "Content-Type: application/json" \
              -d "{\"body\": \"$BODY\"}" \
              "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/issues/comments/$EXISTING"
          else
            curl -s -X POST -H "Authorization: token $REGISTRY_TOKEN" -H "Content-Type: application/json" \
              -d "{\"body\": \"$BODY\"}" \
              "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/issues/${{ env.PR_NUMBER }}/comments"
          fi

      - name: Set failure status
        if: failure()
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Authorization: token $REGISTRY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"state": "failure", "target_url": "", "description": "Preview deployment failed", "context": "preview"}' \
            "${{ env.GITEA_API }}/api/v1/repos/${{ gitea.repository }}/statuses/${{ gitea.sha }}"
